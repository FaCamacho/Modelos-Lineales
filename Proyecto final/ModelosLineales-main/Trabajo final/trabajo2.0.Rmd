---
title: "Trabajo final"
author: "matias"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

library(tidyverse)
library(readxl)
library(here)
library(mixlm)
library(gridExtra)
library(car)
library(skedastic)
library(qqplotr)
library(tseries)
library(emmeans)
library(boot) 







```

```{r}


datos = biometria_peces

#id <- seq(1,nrow(datos),1)

#datos <- cbind(id,datos)

```

## Aalisis exploratorio de los datos

```{r}

str(datos)

summary(datos)

datos = datos %>%  mutate(Peso_gr = as.numeric(Peso_gr),Especie = as.factor(Especie) )


str(datos)

summary(datos)

datos <- datos %>% filter(.,Peso_gr > 0)

summary(datos)


```

## Análisis de supuestos
#Multicolinealidad
```{r}

#Analizando multicolinealidad


vif(lm(Peso_gr~ .-Especie, data = datos))


#Quitando Long2

vif(lm(Peso_gr~ .-Especie-Longitud2, data = datos))

#Quitando Long3

vif(lm(Peso_gr~ .-Especie-Longitud2-Longitud3, data = datos))

#Variables seleccionadas -> "Longitud1" , "Altura_cm" , "Ancho_cm"



```

##Modelos

```{r}


modelo <- lm(Peso_gr~ Longitud1+Altura_cm+Ancho_cm, data = datos)



modelo_ajustado <- lm(log(Peso_gr) ~ (Longitud1)+(Altura_cm)+(Ancho_cm), data = datos)



modelo_ajustado2 <- lm(log(Peso_gr) ~ log(Longitud1)+log(Altura_cm)+log(Ancho_cm), data = datos)


```




## Homoscedasticidad de "Modelo_ajustado2"

```{r}





datos$r_i <- residuals(modelo_ajustado2)  

# residuos

datos$t_i <- rstudent(modelo_ajustado2) #studentizados EXTERNAMENTE 

datos$pred <- fitted(modelo_ajustado2)

# H0) E(eps^2_i) = sigma^2
# H1) E(eps^2_i) = sigma^2 * h(X_1, X_2, ..., X_k)

breusch_pagan(modelo_ajustado2) #No Rechazo H0)


ggplot(datos, aes(x = pred, y = t_i)) + 
  geom_point(color = "red",alpha=0.5,size=1)+
  xlab('Predichos') +
  ylab('Residuos') +
 geom_abline(slope=0, intercept=c(-1,1), linetype="dashed",color="blue")+
  geom_abline(slope = 0, intercept = 0,color="blue")   +theme_bw()



grid.arrange(crPlot(modelo,"Longitud1")
             ,crPlot(modelo,"Altura_cm")
             ,crPlot(modelo,"Ancho_cm"),
             ncol=3,nrow=1)






```

##Normalidad

```{r}

n <- nrow(datos)

z_i <- qnorm(seq(n)/(n + 1))

qq <- data.frame(teoricos = z_i,empiricos = sort(datos$t_i))

ggplot(qq, aes(x = teoricos, y = empiricos)) +
  geom_point() +
  xlab('Cuantiles teoricos') +
  ylab('Cuantiles empiricos') +
  geom_abline(slope = 1, intercept = 0, col = 2, size = 1.5)


# PRUEBA DE HIPOTESIS
# H0) Los errores son normales
# H1) Los errores NO son normales


shapiro.test(datos$t_i) #Rechazo H0) con un alfa=0.006, medio ambiciosos capaz
tseries::jarque.bera.test(datos$t_i) #Rechazo H0)
ks.test(datos$t_i, 'pnorm') #No Rechazo H0)

ggplot(qq, aes(x = empiricos, y=..density..)) +
  geom_histogram(breaks = seq(-3, 3, 1), col = 'white') +
  xlab('Residuos studentizados')
```



## Atípicos

```{r}

h_i <- influence(modelo_ajustado)$hat
D_i <- cooks.distance(modelo_ajustado)
df <- data.frame(i = 1:nrow(datos),
                 h_i = h_i,
                 D_i = D_i)

# Distancia de Cook
ggplot(df, aes(x = i, y = D_i)) +
  geom_point() +
  geom_segment(aes(x = i, xend = i, y = 0, yend = D_i)) +
  xlab('') +
  ylab(expression(D[i])) +
  geom_abline(slope = 0, intercept = 4/50, col = 2, linetype = 'dashed')

#hay algún atípico

```






Graficos

```{r}

ancho <- ggplot(datos, aes(x = log(Ancho_cm), y = log(Peso_gr), color=Especie)) + 
  geom_point(alpha=0.5,size=2)+
  xlab('Ancho') +
  ylab('Peso')

altura <- ggplot(datos, aes(x = log(Altura_cm), y = log(Peso_gr), color=Especie)) + 
  geom_point(alpha=0.5,size=2)+
  xlab('Ancho') +
  ylab('Peso')


longitud <- ggplot(datos, aes(x = log(Longitud1), y = log(Peso_gr), color=Especie)) + 
  geom_point(alpha=0.5,size=2)+
  xlab('Longitud') +
  ylab('Peso')


grid.arrange(ancho
             ,altura
             ,longitud,
             ncol=1,nrow=3)

```


#evaluacion de modelo 

```{r}
 bic1 = BIC(modelo)
bic2= BIC(modelo_ajustado)
bic3 = BIC(modelo_ajustado2)
aic1 = AIC(modelo)
aic2=AIC(modelo_ajustado)
aic3= AIC(modelo_ajustado2)

summary(modelo)$adj.r.squared

summary(modelo_ajustado)$adj.r.squared

summary(modelo_ajustado2)$adj.r.squared




```

## Ancova 

```{r}
## relacion entre especie y peso 


ggplot(datos,aes(x=Especie,y=log(Peso_gr),fill=Especie)) + geom_boxplot()

```


```{r}
alto = ggplot(datos, aes(x = log(Altura_cm), y = log(Peso_gr), col = Especie)) + 
  geom_point(alpha=0.5,size=2) +
  theme_bw() +
  ylab('Peso') +
  geom_smooth(method = 'lm', se = FALSE)

ancho = ggplot(datos, aes(x = log(Ancho_cm), y = log(Peso_gr), col = Especie)) + 
  geom_point(alpha=0.5,size=2) +
  theme_bw() +
  ylab('Peso') +
  geom_smooth(method = 'lm', se = FALSE)

longitud = ggplot(datos, aes(x = log(Longitud1), y = log(Peso_gr), col = Especie)) + 
  geom_point(alpha=0.5,size=2) +
  theme_bw() +
  ylab('Peso') +
  geom_smooth(method = 'lm', se = FALSE)

grid.arrange(alto,ancho,longitud)

```
Parece coexistir 7 pendientes 


```{r}
mod0 = lm(log(Peso_gr) ~ log(Altura_cm), data = datos)
mod1 = lm(log(Peso_gr) ~ log(Altura_cm) + Especie, data = datos)


anova(mod0, mod1)
```
Nos quedamos con el segundo modelo y nos planteamos la siguiente prueba de hipotesis. 
Ho) la pendiente de la  Altura es igual para las especies
H1) Al menos una especie tiene un valor de la pendiente distinta a las demas.

```{r}

mod2.0 <- lm(log(Peso_gr) ~ Especie + log(Altura_cm) + log(Altura_cm):Especie, data = datos)

mod3 <- lm((Peso_gr) ~ Especie , data = datos)

summary(mod2.0)

anova(mod1, mod2.0)


```





```{r, eval=FALSE}
pendientes <- emtrends(mod0, pairwise ~ Especie, var = 'log(Altura_cm)') ## no corre 
library(multcomp)
cld(pendientes, Letters = letters)

emmeans(mod3, ~ Especie)

summary(mod0)

```
## Cross-Validation 

```{r}
set.seed(84735)

cross= prediction_summary_cv(model = modelo,  data = datos, k =10 )

glm.fit <- glm(modelo, data=datos)

cv.err.kfold <- cv.glm(data=datos, glmfit=glm.fit, K=10)
cv.err.kfold$delta[1]
 ## hacer lo mismo para los otros 2 modelos y comparar... ver la fundamentacion
## loo()


```

